<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.8.dev">
<meta name="author" content="ABS Core Competence Center">
<title>IV. The Mathematics Object Model (MOM)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
<h1>IV. The Mathematics Object Model (MOM)</h1>
<div class="details">
<span id="author" class="author">ABS Core Competence Center</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#trueintroduction">1. Introduction</a></li>
<li><a href="#trueinterface">2. Interface</a>
<ul class="sectlevel2">
<li><a href="#truelibrary-interface">2.1. Library Interface</a></li>
<li><a href="#trueexception-store">2.2. Exception store</a></li>
<li><a href="#trueexercise">2.3. Exercise</a></li>
</ul>
</li>
<li><a href="#truemathematics-object-model">3. Mathematics Object Model</a></li>
<li><a href="#truecontexts">4. Contexts</a></li>
<li><a href="#truerecords">5. Records</a>
<ul class="sectlevel2">
<li><a href="#truedata-buffer">5.1. Data buffer</a></li>
<li><a href="#truejson-data-buffer">5.2. JSON data buffer</a></li>
<li><a href="#truechaincache-data-buffer">5.3. ChainCache data buffer</a></li>
</ul>
</li>
<li><a href="#truerelations">6. Relations</a></li>
<li><a href="#trueattributes">7. Attributes</a>
<ul class="sectlevel2">
<li><a href="#truethe-valtype">7.1. The ValType</a></li>
<li><a href="#truegeneric-attributes">7.2. Generic Attributes</a></li>
<li><a href="#trueattributekind">7.3. AttributeKind</a>
<ul class="sectlevel3">
<li><a href="#trueattribute-name">7.3.1. Attribute name</a></li>
<li><a href="#trueattribute-id">7.3.2. Attribute id</a></li>
<li><a href="#trueattribute-type">7.3.3. Attribute type</a>
<ul class="sectlevel4">
<li><a href="#trueattribute-ilk">Attribute Ilk</a></li>
<li><a href="#trueattribute-value-holder">Attribute value holder</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#trueloading">7.4. Loading</a></li>
<li><a href="#truecomputing">7.5. Computing</a></li>
<li><a href="#trueruncalculationrule">7.6. RunCalculationRule</a></li>
<li><a href="#truedependencies">7.7. Dependencies</a>
<ul class="sectlevel3">
<li><a href="#truedependencies-for-calculation-rules">7.7.1. Dependencies for calculation rules</a></li>
<li><a href="#truedependencies-for-ranges">7.7.2. Dependencies for ranges</a></li>
<li><a href="#truedependencies-for-cpl-tables">7.7.3. Dependencies for CPL tables</a></li>
</ul>
</li>
<li><a href="#truegetrange">7.8. GetRange</a></li>
<li><a href="#truesaving">7.9. Saving</a></li>
</ul>
</li>
<li><a href="#truelogging">8. Logging</a>
<ul class="sectlevel2">
<li><a href="#truelogging-configuration">8.1. Logging configuration</a></li>
<li><a href="#trueconversionpattern">8.2. ConversionPattern</a></li>
<li><a href="#trueusage-in-code">8.3. Usage in code</a></li>
</ul>
</li>
<li><a href="#trueconfiguration">9. Configuration</a>
<ul class="sectlevel2">
<li><a href="#trueexercise-2">9.1. Exercise</a></li>
</ul>
</li>
<li><a href="#truecontext-descriptors">10. Context Descriptors</a>
<ul class="sectlevel2">
<li><a href="#trueloader">10.1. Loader</a></li>
<li><a href="#truecomputer">10.2. Computer</a></li>
<li><a href="#truefinder">10.3. Finder</a></li>
</ul>
</li>
<li><a href="#truecontext-iterator-algorithms">11. CONTEXT ITERATOR ALGORITHMS</a></li>
<li><a href="#trueoverview-framework-classes">12. Overview framework classes</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="trueintroduction"><a class="anchor" href="#trueintroduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All examples are taken from the project math_life or abs-mathcom. The project sources are part of the delivery. All paths in this document regarding the math_life project are relative from ABS_MATHLIFE/src/. All paths in this document regarding the abs-mathcom project are relative from ABS_MATHCOM/src/.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The purpose of the MOM is simplifying and flattening the hierarchical structure of the ABS database model to a context and attribute based interface of a calculator engine. The MOM provides the needed input values to and fetches the calculated output values from the rating engine.</p>
</div>
<div class="paragraph">
<p>The MOM is platform independent and able to run on Linux and Windows systems. That is one of the reasons why C++ was the programming language of choice for the MOM in the first place.</p>
</div>
<div class="paragraph">
<p>The MOM is compiler independent. Therefore it is important to keep to the C++ standards even if certain compilers allow for non-standard coding. The ABS-SDK as well as the exapmle projects are being delivered with cmake files for building the complete environment needed.</p>
</div>
<div class="paragraph">
<p>As an initial situation we have the ABS data model which is a relational database and organized in a hierarchical structure within business objects. For example TVERTRAG → TVERSVERTRAG → TPRODAUS (Contract → Coverage → Coverage Item)</p>
</div>
<div class="paragraph">
<p>As mentioned above the MOM maps the ABS database model to the interface of a rating engine (e.g. Calculus Prime Life). These rating engines have no knowledge of the ABS or of any other data model.</p>
</div>
<div class="paragraph">
<p>To achieve this and to reduce complexity the MOM should only consider tables holding data relevant for the rating process. In fact only a very small part of the data model is needed to perform calculations.</p>
</div>
<div id="img-rss-help" class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/mapping-abs-to-rating.jpg" alt="mapping abs to rating">
</div>
<div class="title">Figure 1. Mapping of ABS data model to rating engine</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueinterface"><a class="anchor" href="#trueinterface"></a>2. Interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MOM code is implemented and shiped in shared libraries. Each instance of the MOM is an independent library. In Windows the libraries are realized as .dll-files and in Linux as .so-files.</p>
</div>
<div class="paragraph">
<p>This chapter explains the MOM interface to the calling world and how to implement it.</p>
</div>
<div class="sect2">
<h3 id="truelibrary-interface"><a class="anchor" href="#truelibrary-interface"></a>2.1. Library Interface</h3>
<div class="paragraph">
<p>The following interfaces have to be implemented to ensure the library can be accessed from the calling layers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">int	DLL_CALLING_CONVENTION LINUX_EXPORT init(const char *,	const char *top_class,	const char *top_pkey,	const char *da_source,	const char *da_target,	const char *iniFileNmae, math_if_handle_t *handle)

int DLL_CALLING_CONVENTION LINUX_EXPORT init2(const char *,	const char *top_class,	const char *top_pkey,	const char *da_source,	const char *da_target,	const char
*session_id,	math_if_handle_t *handle)

int DLL_CALLING_CONVENTION LINUX_EXPORT init3(const char *, const char *top_class,
const char *top_pkey, 	const char *da_source, const char *da_target, const char *defSession_id, const char *opSession_id, math_if_handle_t *handle)

int DLL_CALLING_CONVENTION LINUX_EXPORT init_rest(const char *, const char * operationalData, math_if_handle_t *handle)

int DLL_CALLING_CONVENTION LINUX_EXPORT compute(math_if_handle_t handle, const char *pclass, const char *pkey, const char *attribute)

int DLL_CALLING_CONVENTION LINUX_EXPORT uninit(math_if_handle_t handle)

int DLL_CALLING_CONVENTION LINUX_EXPORT getlasterror(math_if_handle_t handle,

int DLL_CALLING_CONVENTION LINUX_EXPORT getmathtrace(math_if_handle_t handle, char *pszAttribute, char *pszValue)

int	DLL_CALLING_CONVENTION LINUX_EXPORT set_param(math_if_handle_t handle,

int DLL_CALLING_CONVENTION LINUX_EXPORT get(math_if_handle_t handle, const char * option, char *value, size_t * length)

int	DLL_CALLING_CONVENTION LINUX_EXPORT getlibraryoption(math_if_handle_t instance, const char *option, char *value, size_t * length)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the definitions of DLL_CALLING_CONVENTION and LINUX_EXPORT see CPP_BASIS/src/system/platform_definitions.h</p>
</div>
<div class="paragraph">
<p>Example: math_life/pbo/tlife_cmath.cpp and declarations math_life/client/cmathall.h in math_life project.</p>
</div>
<div class="paragraph">
<p>Mind that for Windows a .def file is needed as well.
Example: math_life.def in math_life project.</p>
</div>
<div class="paragraph">
<p>Some of the interface methods are deprecated and can be implemented like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">int	DLL_CALLING_CONVENTION LINUX_EXPORT  init(const char *,
	const char *top_class,
	const char *top_pkey,
	const char *da_source,
	const char *da_target,
	const char *iniFileNmae,
	math_if_handle_t *handle)
{
    return -1;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These methods are <em>init</em>, <em>init2</em>, <em>init3</em>, <em>getlasterror</em> and <em>forget</em>. Currently these methods still have to be inplemented due to the fact that they are expected by the calling layer. In future versions they might be left out alltogether.</p>
</div>
<div class="paragraph">
<p><em>math_com/math_shared/math_if_impl.h</em> provides template functions for the implementation of the above mentioned interfaces.</p>
</div>
<div class="paragraph">
<p>For example:<br>
<em>template&lt;typename T&gt;<br>
int  init_rest_impl(const char* operationalData, math_if_handle_t *handle)</em></p>
</div>
<div class="paragraph">
<p>is used like this in tlife_cmath.h:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">int  DLL_CALLING_CONVENTION LINUX_EXPORT init_rest(const char *,
    const char * operationalData,
    math_if_handle_t *handle)
{
    TRACE_START(NULL, "init_rest");
    return init_rest_impl&lt;InterfaceMathLife&gt;(operationalData, handle);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>class InterfaceMathLife is a subclass of OrbitMath&lt;T&gt; where the type parameter is class mathContract and is the jumping point into the MOM.</p>
</div>
<div class="paragraph">
<p>mathContract is a subclass of mathbase&lt;T&gt; where the type parameter is the root context (usually the contract context) of the object model. In case if the math_life project this is the class ContractContext.
mathContract implements only specific code of the math_life project. The rest is left to the base class mathbase&lt;T&gt;</p>
</div>
<div class="paragraph">
<p>The classes OrbitMath and mathbase are part of the MOM framework and thus part of the abs-mathcom project.</p>
</div>
<div class="paragraph">
<p>The name of the class OrbitMath derives from the fact that it still is used in other MOM implementations that use Orbit for persisting data. math_life has no Orbit connection due tu the fact that it can be accessed via rss only.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Class Diagram of InterfaceMathLife/OrbitMath/mathContract/mathbase/ContractContext</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/library-interface.svg" alt="library interface">
</div>
</div>
<div class="paragraph">
<p>The method <em>mathbase::init()</em> creates the root context of the context hierarchy, In this case of class <em>ContractContext</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">    virtual short init(short trace, const char * key, const char * topclass)
	{
		boost::shared_ptr&lt;TKtx&gt; ps(new TKtx(std::string(key)));  <i class="conum" data-value="1"></i><b>(1)</b>
		...
	}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the actual context is created.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueexception-store"><a class="anchor" href="#trueexception-store"></a>2.2. Exception store</h3>
<div class="paragraph">
<p>The class <em>ExceptionStore</em> handles occured excepions. All interface methods in math_if_impl.h use <em>ExceptionStore</em> in their catch blocks to store occured exception.<br>
class <em>OrbitMath</em> reads the stored exceptions and adds them to the rss response JSON.
If one needs some special treatment (e.g. conversion) of error messages an inherited class can be created and it&#8217;s save method overwritten.<br></p>
</div>
<div class="paragraph">
<p>Example: <em>ExceptionStoreLife</em> in tlife_errmg.h</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/exception-store.svg" alt="exception store">
</div>
</div>
<div class="paragraph">
<p>To activate the new class simply call static method <em>ExceptionStore::SetInstance()</em> in the overwritten method <em>InitExceptionStore()</em> of the class inherited from class <em>OrbitMath</em>.<br>
In the math_life project this would be <em>InterfaceMathLife::InitExceptionStore</em> for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">    void InitExceptionStore()
	{
		ExceptionStore::SetInstance(boost::shared_ptr&lt;ExceptionStore&gt;(new ExceptionStoreLife));
	}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueexercise"><a class="anchor" href="#trueexercise"></a>2.3. Exercise</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Create a custom MOM solution using CMakelists.txt for generating the solution with a root context class. Name the class <em>TrainingContractContext</em>.<br>
CMakelists.txt from the sample solution GFB_MATHLEB can be used as a starting point how to build a project on top of the ABS-SDK.
<em>TrainingContractContext</em> should inherit from classes <em>TcdSharedContext</em> and <em>RootObjectCtx</em> in a first step. Both classes are part of the framework.<br>
All classes except <em>TrainingContractContext</em> are interface classes and should be put in a directory (e.g. named "interface").<br>
Class <em>TrainingContractContext</em> should be put in a separate directory (e.g. named "product").<br>
Name all classes created by you with "<em>Training</em>" as a prefix.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Look at sample project in folder 02_INTERFACE to see what classes and sources you need to create a library interface.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truemathematics-object-model"><a class="anchor" href="#truemathematics-object-model"></a>3. Mathematics Object Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MOM creates a tree of contexts, with each context representing one or more database tables. Contexts can have other contexts as children.
Each context holds a list of attributes relevant for the rating engine.</p>
</div>
<div class="paragraph">
<p>Although this means there is a hierarchy of contexts here the complexity is far less than the complexity of the ABS data model.</p>
</div>
<div class="paragraph">
<p>To feed the rating engine with its required attributes, specific calculations and search algorithms can be applied to each attribute.</p>
</div>
<div class="paragraph">
<p>The main components of the MOM are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Records</strong><br>
Records represent a row of a table in the ABS data model. Records are platform independent and access data source dependend data buffers.</p>
</li>
<li>
<p><strong>Relations</strong><br>
Relations enable dependencies between tables. They are used to find dependend records and for building the hierarchy of contexts. Ralations can be seen as a 1:n relationship of records.</p>
</li>
<li>
<p><strong>Attributes</strong><br>
An Attribute represents a value and in some cases a list of a table needed for rating. There are several kinds of attributes.</p>
</li>
<li>
<p><strong>Types</strong><br>
Attributes hold different types of values like amounts, characters, dates or percentages. Typically, rating engines can only deal with certain kinds of numbers (usually floating point). Types make sure that the conversion from and to the rating engine works correctly.</p>
</li>
<li>
<p><strong>Contexts</strong><br>
Contexts are the glue that binds records and attributes together into logical units. Contexts are organized in hierarchies.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecontexts"><a class="anchor" href="#truecontexts"></a>4. Contexts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Contexts are containers which hold attributes and records. One context can have many attributes and many records.<br>
Attribute contexts initialize attributes and records in their constructors.<br>
Contexts are responsible for creating and destroying their child contexts. This is done in the loading methods.<br></p>
</div>
<div class="paragraph">
<p>During calculation it is the responsibilty of contexts also to start sub-calculations.</p>
</div>
<div class="paragraph">
<p>Attribute contexts can alter the finding algorithm to look for attributes in parent and child contexts.</p>
</div>
<div class="paragraph">
<p>Contexts are used to denormalize data as well. It is possible to hold more than one record of a database table within one context.<br>
An example for denormalization would be several attributes linked to TZUABSCHLAG.ZUABPROZENT within the insured person context. Each attribute can be mapped to a specific record by the data column TZUABSCHLAG.ZUABART.</p>
</div>
<div class="paragraph">
<p>All context classes must inherit from class <em>AttributeContext</em> which offers most of the framework funktions needed for a MOM out of the box.<br>
In case of a CPL-based MOM the context classes must inherit from class <em>TcdSharedContext</em>.</p>
</div>
<div class="paragraph">
<p>Contexts are organized in hierarchies. In these hierarchies the parents know all their children and vice versa. This allows search algorithms to search in both directions up and down.</p>
</div>
<div class="paragraph">
<p>Here is an example of the class hierarchy of class <em>ContractContext</em> in math_life which. Here a class <em>BaseContext</em> was created also to deal with math_life specifics. All contexts in math_life would inherit from <em>BaseContext</em>.</p>
</div>
<div class="paragraph">
<p>class <em>ContractContext</em> inherits from class <em>RootObjectCtx</em> as well.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/contract-context.svg" alt="contract context">
</div>
</div>
<div class="paragraph">
<p>This example shows some more contexts of the math_life project:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/context-inheritance-life.svg" alt="context inheritance life">
</div>
</div>
<div class="paragraph">
<p>A typical context tree usually consists of the following levels:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a contract context class on top</p>
</li>
<li>
<p>a coverage context class</p>
</li>
<li>
<p>a tariff context class</p>
</li>
<li>
<p>an insured person and / or insured object context classes dependng on the line of business.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course each level can contain several context classes. It could male sense for example to have several context classes on tarff level. One context for tariffs and one for less complex claues.</p>
</div>
<div class="paragraph">
<p>Here ist the full context tree of math_life contexts whithout the framework classes. Gere class <code>TarrifCtxParent</code> serves as a base class for CoverageItemContext and could be the base class for a class named <code>ClauseContext</code> as well (wich does mot exist  here).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/context-tree-life.svg" alt="context tree life">
</div>
</div>
<div class="paragraph">
<p>Mind that this diagram does not show the inheritance hierarchy of the context classes. They all are derives from class <code>BaseContext</code> of course.</p>
</div>
<div class="paragraph">
<p>The life cycle of a context consists of three phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Loading</strong><br>
During loading, a context builds its own records and attributes and its child contexts. Then triggers the loading of its child contexts.</p>
</li>
<li>
<p><strong>Calculation</strong><br>
Here a complete or a partial compute is performed. Calculations can be performed more than once.</p>
</li>
<li>
<p><strong>Clean up</strong><br>
During clean up, child contexts, records and attributes are destroyed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to build an actual hierarchy of context objects is explained in chapter <a href="#trueloading">Loading</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truerecords"><a class="anchor" href="#truerecords"></a>5. Records</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Records represent one row in a table of the ABS data model identified by its primary key. Apart from tables in the database a record can also point to a virtual table. Virtual tables are extensions of the ABS data model which are not persisted and exist in memory only.</p>
</div>
<div class="paragraph">
<p>Records are data source independent. Records are used to access a data buffer interface. For each platform these data buffers are implemented to access the according data source. Examples are Orbit data buffers for the ABS client and PLI data buffers for the Host environment.</p>
</div>
<div class="paragraph">
<p>Records can be created either by using a primary key or by using class Relation to create a dependent record. On creation of a record the name of the table, the name of the primary key column and the value are input parameters. The primary key is optional at creation time and can be set later.</p>
</div>
<div class="paragraph">
<p>In the following example we have two records: m_ContractRecord and m_InsuranceProductRecord. m_ContractRecord’s primary key is set via its constructor because it is known at construction time. m_MainClassRecord’s primary key is set while loading the context. Here the method <code>SetKey()</code> is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ContractCtx::Load () {
...

    m_MainClassRecord.SetKey(m_HSPKey.Get().AsString());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further down <code>ContractCtx::Load()</code>  one can see how class <code>Relation</code> is used to get dependent records for table TVERSVERTRAG.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ContractCtx::Load () {
...

    Relation r(&amp;m_ContractRecord, "TVERSVERTRAG", "VERSV#", e_Current); <i class="conum" data-value="1"></i><b>(1)</b>
	for (int i = 0; i &lt; r.size(); i++){
		Record *rec = r.RecordPtr(i); <i class="conum" data-value="2"></i><b>(2)</b>

		std::string sState = rec-&gt;GetValue("ZUSTAND"); <i class="conum" data-value="3"></i><b>(3)</b>

		if (sState != "S") {
			CoverageContext *pCoverage = new CoverageContext(r.Value(i), this); <i class="conum" data-value="4"></i><b>(4)</b>
			m_vCoverage.push_back(pCoverage);
		}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Class <code>Relation</code> is used to get related coverages (TVERSVERTRG) from current record.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A pointer to a Record can be obtained by using <code>RecordPtr()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This Record is used to fetch a value. In this case the state (ZUSTAND) to decide if child context should be created.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Instance of class <code>CoverageContext</code> is created.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If a primary key consists of more than one column, names and values will be tabulator separated.</p>
</div>
<div class="paragraph">
<p>Example: Insured Person</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">InsuredPersonCtx::InsuredPersonCtx (const std::string &amp; key, TariffCtx* tariff)
    : ProtoCtx(key, tariff)
    , m_Descriptor(this)
    , m_InsuredPersonRecord(key, "PAP#\tNP#", "TVERSPERS")
    , m_NaturalPersonRecord("", "NP#", "TNATPERS")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Records are used by persistent attributes of (subclsses of class Attribute) to read input values and to persist calculated values to the data source.</p>
</div>
<div class="sect2">
<h3 id="truedata-buffer"><a class="anchor" href="#truedata-buffer"></a>5.1. Data buffer</h3>
<div class="paragraph">
<p>Data buffers handle the actual read and write operations of records and are accessed by the class <code>Record</code> via the abstract interface class <code>DataBuffer</code>.</p>
</div>
<div class="paragraph">
<p>Data buffers implement the data buffer interface and are data source dependent. That means each kind of data source supported by MOM has its own implementation.</p>
</div>
<div class="paragraph">
<p>The relevant DataBuffer implementations are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>JSON data buffer</strong></p>
</li>
<li>
<p><strong>Cache chain data buffer</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some more implementations of the data buffer interface like OrbitDatabuffer and HOSTDataBuffer. But since these are obsolete and cannot be used any more in a web service environment, they will not be part of this training.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/record-databuffer.svg" alt="record databuffer">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truejson-data-buffer"><a class="anchor" href="#truejson-data-buffer"></a>5.2. JSON data buffer</h3>
<div class="paragraph">
<p>Represents JSON element<br>
Data buffer for operative data<br>
RSS only
&lt;br&gt;
No database access</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/databuffer-hierarchy.svg" alt="databuffer hierarchy">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truechaincache-data-buffer"><a class="anchor" href="#truechaincache-data-buffer"></a>5.3. ChainCache data buffer</h3>
<div class="paragraph">
<p>Generated or configured in TRATDATCOLCONFIG<br>
Different chain for defining data and operative data<br>
Minimizes DB access.</p>
</div>
<div class="paragraph">
<p>ChainCache data buffer defining:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MemoryCacheSerializer</p>
</li>
<li>
<p>RedisCacheSerializer (switch MATH_USE_REDIS)</p>
</li>
<li>
<p>InfinispanRESTCacheSerializer (switch MATH_USE_INFINISPAN_REST)</p>
</li>
<li>
<p>DBCacheSerializerDD</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ChainCache data buffer operational:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MemoryCacheSerializer</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/cachechaindatabuffer.svg" alt="cachechaindatabuffer">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truerelations"><a class="anchor" href="#truerelations"></a>6. Relations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With relations dependencies can be found. For example a relation from the TVERTRAG record to TVERSVERTRAG and its primary key VERSV# delivers information of all dependent TVERSVERTRAG rows either in the form of the primary key or TVERSVERTRAG records.</p>
</div>
<div class="paragraph">
<p>Example class Relation contract to coverage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">Relation recordsCoverage(&amp;m_ContractRecord, "TVERSVERTRAG", "VERSV#",
                         Current);
…
for (Relation::size_type i = 0; i &lt; recordsCoverage.size(); i++) {
    CoverageCtx *pCoverage = new CoverageCtx(recordsCoverage.RecordPtr(i)-&gt;GetKey(), this); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Method <code>RecordPtr()</code> gets a pointer to a record object representing the current row in the relation. These records are temporarily and will be destroyd in de destrucot of the <code>Relation</code> object.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueattributes"><a class="anchor" href="#trueattributes"></a>7. Attributes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Attributes deliver the actual input to the calculation engine and also hold the outputs of calculations or formulas. These two roles are not mutually exclusive.<br>
Attributes can be persistent Attributes meaning that they have representation within the persistence layer or are transient without having representation within the persistence layer.<br>
Persistent attributes represent exactly one field in the persistence layer and are connected to a certain record. Persistent attributes are able to set and get data from the underlying data buffer. There are different types of persistent Attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Input attributes</strong><br>
Input attributes are read only. These values can change their value between computations. Use class <code>InputAttribute</code> for input attributes.</p>
</li>
<li>
<p><strong>Defining attributes</strong><br>
Defining attributes are read only and represent a value from a table of the GGRL. Once read, the value of a defining attribute never changes.
Use class <code>DefiningAttribute</code> for input attributes</p>
</li>
<li>
<p><strong>Operational Attributes</strong><br>
Theses Attributes have read and write access. Operational Attributes typically hold the results of calculations.
Use Generic Attributes or specializations of class Attribute to define operational attributes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Another group of attributes are transient or internal attributes. These attributes do not represent a field in the persistence layer and are typically used to hold intermediate results. The record member of those attributes will be null. Use Generic Attributes or specializations of class Attribute to define these these attributes.</p>
</div>
<div class="paragraph">
<p>Attributes can hold five different values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Current value</strong><br>
Holds the current value.</p>
</li>
<li>
<p><strong>Input Value</strong><br>
Holds the value from the persistence layer. For example, while accessing Orbit this is the current value of the Persistent Object in Orbit.</p>
</li>
<li>
<p><strong>Old value</strong><br>
Holds the old value. For example, while accessing Orbit this is the original value of the Persistent Object in Orbit.</p>
</li>
<li>
<p><strong>Previous value</strong><br>
Holds the current value of a previous calculation. Useful for projection calculations.</p>
</li>
<li>
<p><strong>Old previous value</strong><br>
Holds the old value of a previous calculation. Useful for projection calculations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Attributes can have ids or names for the calculation engine to identify them. Ids are integers, names are strings. Search algorithms within the Object Model find the correct attributes by these ids or names.</p>
</div>
<div class="paragraph">
<p>To get the value of an attributes one can use two methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Attribute::Get()</code> method family: These will get the respective value. If the value has not been calculated yet, this will trigger the calculation of the value by calling its <code>Calculate()</code> or <code>CalculateOld()</code>  methods.</p>
</li>
<li>
<p><code>Attribute::Get()</code> method family: This will just return the respective value. If the value has not been calculated yet no calculation will be triggered and an empty value will be returned.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="truethe-valtype"><a class="anchor" href="#truethe-valtype"></a>7.1. The ValType</h3>
<div class="paragraph">
<p>The five different values of an attribute are identified by the enum <code>ValType</code>. It is used to receive one of these values.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/enum-valtype.svg" alt="enum valtype">
</div>
</div>
<div class="paragraph">
<p>To receive one of these values there are two ways. One can use the methods <code>Attribute::Get()</code> or <code>Attribute::Value()</code> for e_CurrentValue, <code>Attribute::GetOld()</code> or <code>Attribute::Value()</code> for e_OldValue and so on.</p>
</div>
<div class="paragraph">
<p>Or one uses the helper class <code>ValueGetter</code>. The interface of class `ValueGetter`looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class ValueGetter
{
    /// class ValueGetter
    /// Functional object to parametrize getting the various kinds of value.
public:
    ValueGetter( Attribute&amp; attr );
    const Type* operator()
                (Attribute::ValType bValueType = Attribute::e_CurrentValue,
                 bool bMitAbfragen = true) const;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example of receiving a value using <code>ValueGetter</code> can be found in  <code>CoverageItemContext::GetYieldDate_YieldPercentage</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">Date CoverageItemContext::GetYieldDate_YieldPercentage( bool bOld /*= false */ )
{
    Date datAG;

    datAG = *(ValueGetter(m_YieldAllocationDate)( bOld? Attribute::e_OldValue : Attribute::e_CurrentValue )); <i class="conum" data-value="1"></i><b>(1)</b>
    datAG = datAG.SubtractYears( 2 );

    return datAG;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Depending on value of <code>bOld</code> either <code>e_CurrentValue</code> or <code>e_OldValue</code> is fetched.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truegeneric-attributes"><a class="anchor" href="#truegeneric-attributes"></a>7.2. Generic Attributes</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">template
&lt; class TBaseClass
, class TParentCtx
, const char* attr_name
, const char* attr_persistent_name
, int tcd_id
, int tcd_old_id
, int tcd_sek_id
, int tcd_sek_ old _id
, class TType
, bool is_inquire
, Characteristic characteristicOld = Old
&gt;
class GenericAttribute : public TBaseClass</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the Curiously Recurring Template Pattern (CRTP) is used to inherit the implementation of TBaseClass into the GenericAttribute class.</p>
</div>
<div class="paragraph">
<p>Template parameter TBaseClass is either class Attribute or one of the specializations of class Attribute. It is not recommended to use class Attribute as template parameter TBaseClass.
Two helper macros are used to declare template parameters for instantiation of generic attributes. These are necessary because the template parameters attr_name and attr_persistent_name are of type const char * and therefore they need to be compile time constants. This is achieved by declaring their values with an external linkage.</p>
</div>
<div class="paragraph">
<p>The macros names are DECL_ATTR_NAME(name) and IMPL_ATTR_NAME(name) and they expand to declare a constant char array named ksname</p>
</div>
<div class="paragraph">
<p>Declaration of DECL_ATTR_NAME:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#define DECL_ATTR_NAME(name) extern const char ksname[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example of the partial specialization of GenericAttribute: Here we do not specialize the attribute name, nor the column name in the data model, nor the attribute id and the type:
Header File:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">template
    &lt; class TContext
    , const char* attr_name
    , const char* attr_persistent_name
    , int attr_id
    , class TType&gt;
class GenericAttributeWithId: public GenericAttribute&lt;Attribute, TContext, attr_name, attr_persistent_name, attr_id, -1, -1, -1, TType, false&gt;
{
  public:
    typedef GenericAttribute&lt;Attribute, TContext, attr_name,
                             attr_persistent_name, -1, -1, -1, -1,
                             TType, false&gt; _Attr_Base;
    GenericProtoAttribute( TContext* pParent, Record* r = NULL )
        : _Attr_Base ( pParent, r ) {}
  private:
    GenericProtoAttribute();
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can declare our own attribute class by fully spezializing the missing parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">DECL_ATTR_NAME(ClassPrNet);
DECL_ATTR_NAME(ClassPrNetCol);
typedef GenericAttributeWithId &lt;ksClassPrNet, ksClassPrNetCol, 8, Zahl&gt;
        ClassPrNetBase;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the source file the only things left to do are the IMPL_ATTR_NAME macros for attribute name and data model name and the calculation methods Calculate() and CalculateOld() as needed:
Source file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">IMPL_ATTR_NAME(ClassPrNet, "ClassPrNet");
IMPL_ATTR_NAME(ClassPrNetCol, "JPRNETTO");

void ClassPrNet::Calculate()
{
    …
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example of a hierarchy of a generic attributes with both an attribute without persistence (ContractNetPremium) and one with persistence (RateClass). Both classes can be found in</p>
</div>
<div class="paragraph">
<p>math_life/tarif/tlife_contract_attribute.h</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/generic-attribute-hierarchy.svg" alt="generic attribute hierarchy">
</div>
</div>
<div class="paragraph">
<p>template
&lt; class TBaseClass
, class TParentCtx
, const char* attr_name
, const char* attr_persistent_name
, int tcd_id
, int tcd_alt_id
, int tcd_sek_id
, int tcd_sek_alt_id
, class TType
, bool is_inquire
, Characteristic characteristicOld = e_Old
&gt;
class GenericAttribute : public TBaseClass</p>
</div>
<div class="paragraph">
<p>class ContractNetPremium</p>
</div>
<div class="listingblock">
<div class="title">h file</div>
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">///-----------------------------------------------------------------------------
/// Declaration of ContractNetPremium
DECL_ATTR_NAME(ContractNetPremium);
typedef GenericContractAttribute&lt;ksContractNetPremium, ksNotPersistent, -1, -1, -1, -1, Number, false, e_Old&gt; ContractNetPremiumBase;
class ContractNetPremium : public ContractNetPremiumBase
{
	///
	/// Class ContractNetPremium
	/// This class determines the net premium on contract level
	///
public:
	ContractNetPremium(ContractContext* pParent, Record * pRec) : ContractNetPremiumBase(pParent, pRec) {};
	double NetPremiumFromGross();

protected:
	void Calculate() override;
	void CalculateOld() override;
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">cpp file</div>
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">// Class ContractNetPremium
IMPL_ATTR_NAME(ContractNetPremium, "ContractNetPremium");

///
/// calculates the net premium on contract level
///
void ContractNetPremium::Calculate()
{
  ...
}

///
/// determines the net premium out of a given gross premium
///
double ContractNetPremium::NetPremiumFromGross()
{
  ...
}

///
/// calculate the original net premium on contract level
///
void ContractNetPremium::CalculateOld()
{
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>class RateClass</p>
</div>
<div class="listingblock">
<div class="title">h file</div>
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">///-----------------------------------------------------------------------------
/// Declaration of RateClass
DECL_ATTR_NAME(RateClass);
DECL_ATTR_NAME(RateClassField);
typedef GenericContractAttribute&lt;ksRateClass, ksRateClassField, e_RateClass_n_SKIX, e_RateClass_o_SKIX, -1, -1, Text, false, e_Old&gt; RateClassBase;
class RateClass : public RateClassBase
{
	///
	/// Class RateClass
	/// This class determines the rate class
	///
  public:
	  RateClass(ContractContext* pCtx, Record* r) : RateClassBase(pCtx, r) {
	     ...
	  };

  protected:
      void Calculate() override;
      void CalculateOld() override;
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">cpp file</div>
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">// Class RateClass
IMPL_ATTR_NAME(RateClass, "RateClass");
IMPL_ATTR_NAME(RateClassField, "TARIFBEREICH");
///
/// determines the rate class based on the input - if empty the old value is used
///
void RateClass::Calculate()
{
   ...
}

///
/// in new business the current value is used as original value
/// in all other cases the stored value is used
///
void RateClass::CalculateOld()
{
   ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueattributekind"><a class="anchor" href="#trueattributekind"></a>7.3. AttributeKind</h3>
<div class="paragraph">
<p>This class contains most important properties of the attribute,
like table, column, CPL-ID (TCD-ID) and type prototype. Every attribute class holds a static object of this class.</p>
</div>
<div class="paragraph">
<p>Class <code>AttributeKind</code> has the following <code>Init()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">   void Init(const std::string&amp; name,
             int id, int alt_id, int sek_id, int sek_alt_id,
             const std::string&amp; column,
             Type* proto,
             bool is_inquire = false,
             Characteristic ausprAlt = e_Old );</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>name: Attribute name</p>
</li>
<li>
<p>Several CPL ids: id, old id, secondary id, old secondary id</p>
</li>
<li>
<p>column: database column</p>
</li>
<li>
<p>proto: prototype of attribute type</p>
</li>
<li>
<p>is_inquire: states if an attribute is an inquiry attribute</p>
</li>
<li>
<p>ausprAlt: states the characteristic of an old value (usually e_Old)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="trueattribute-name"><a class="anchor" href="#trueattribute-name"></a>7.3.1. Attribute name</h4>
<div class="paragraph">
<p>The name of the attribute can be any chosen name. Good practice however is to use the columns name of the attribute in the database table if the attribute is a persistent attribute. If the database column is not specified, this name will be used as default.<br>
For example an attribute TVERSVETRAG.STADIUM could have name "STADIUM".</p>
</div>
<div class="paragraph">
<p>Sometimes it is not possible to have the database column name as attribute name. This is the case when denormalizing happend and more then one record of a table exist in one context. For example if there are multiple records of TZUABSCHLAG in a coverage item context one cannot name all of them ZUABPROZENT. IN this case the attribute name and the database column will be deifferent.</p>
</div>
</div>
<div class="sect3">
<h4 id="trueattribute-id"><a class="anchor" href="#trueattribute-id"></a>7.3.2. Attribute id</h4>
<div class="paragraph">
<p>The four id an attribute can hold represent the CPL ids of an attribute. These are the id, the old id (id of this attribute in the original contract of an amended one for example), the secondary id and the old secondary id (needed for example if there are two insured persons in or below one context).</p>
</div>
</div>
<div class="sect3">
<h4 id="trueattribute-type"><a class="anchor" href="#trueattribute-type"></a>7.3.3. Attribute type</h4>
<div class="paragraph">
<p>The information of how an attribute is communicated to and from a calculator engine is held by an instance of a class that is inherited from class Type. The most common type classes are <code>Number</code>, <code>Text</code>, <code>Date</code> and <code>Percect</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/typehierarchy.svg" alt="typehierarchy">
</div>
</div>
<div class="paragraph">
<p>The main responsibility of the type classes is to convert data into numbers for the input of the rating engine and from numbers back into original data type for the output of the rating engine.</p>
</div>
<div class="paragraph">
<p>The method <code>AsDouble()</code> returns the value of the attribute converted to a number.<br>
For numbers this is of course exactly that number. For all other type classes conversions will take place.
The type <code>Date</code> converts a date with the following formula into an integer value that can be used in CPL:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>year + month * 10000 + day of month * 1000000</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>25 December, 1642 would be
1642 + (10000 * 12) + (1000000 * 25) = 25121642.</pre>
</div>
</div>
<div class="paragraph">
<p>Class <code>Percent</code> and <code>PerMill</code> take the value and divide it by 100 and 1000 respectively.</p>
</div>
<div class="paragraph">
<p>Texts are different of course. They do not have a value that could be translated to a numeric value outright. In this case we use conversion lists. Conversion lists define a numerical counterpart for each possible value.</p>
</div>
<div class="paragraph">
<p>Lets take the attribute Gender from MathProto for example.<br>
Its textual value can be M and W. with the former being male and the later female.<br>
Lets assume the rating  engine defines the numerical value 1 means male and 2 means female.<br>
So our conversion would look like this: M is 0, W is 2.<br>
This is useful when the calculator engine doesn’t want to or is unable to use text values.</p>
</div>
<div class="paragraph">
<p>There are two ways to set a converion map in the class <code>Text</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the constuctor of class <code>Text</code>.</p>
</li>
<li>
<p>Method <code>Text::TakeOver()</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example of setting a conversion map directly in the constructor of the class <code>Text</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">...
   , m_ReasonForAmend1 (this, &amp;m_ContractRecord, "AUSFGRUND1",
                        new Text(math::make_map("G01", 1.0), conversion_map::all_default, 0.0 ))
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example of setting a conversion via method <code>TakeOver()</code>. Here in the constructor of the attribute class <code>Gender</code> in tlife_ip_attributes.h:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">	  Gender(InsuredPerson_Context* pIPCtx, Record* r) : GenderBase(pIPCtx, r) {
		  conversion_map&amp; cm = const_cast&lt;conversion_map&amp;&gt;(Kind()-&gt;GetConversionMap());
		  cm.TakeOver(math::assign::map_list_of("M", 0.0)("W", 1.0));
	  };</code></pre>
</div>
</div>
<div class="paragraph">
<p>The helper method make_map allows us to easily create conversion maps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">new Text(math::make_map("M", 1.0)("X", 1.0)("N", 1.0)("W", 2.0),
         conversion_map::empty_default, 0.0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method GetValue() returns an object of type ValueHolder which can be used to set a value as double or string.</p>
</div>
<div class="sect4">
<h5 id="trueattribute-ilk"><a class="anchor" href="#trueattribute-ilk"></a>Attribute Ilk</h5>
<div class="paragraph">
<p>Each attribute type has an ilk assigned to ensure comparaibilty of attribute values.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/enum-classtype.svg" alt="enum classtype">
</div>
</div>
</div>
<div class="sect4">
<h5 id="trueattribute-value-holder"><a class="anchor" href="#trueattribute-value-holder"></a>Attribute value holder</h5>
<div class="paragraph">
<p>Due to the fact that often the value of an attribute has to be interpreted as a string and as a number at the same time it can be interpreted as both at any time. This is done by the framework classes <code>ValuesHolder</code>, <code>StringRep</code> and <code>DoubleRep</code>.
An instance of class <code>ValuesHolder</code> is also a member of class <code>Type</code>. The implementation ensures transparent conversion between the two representations. This is done at the latest possible point in time and only if necessary.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/valueholder.svg" alt="valueholder">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">DECL_ATTR_NAME(TechnicalBegin);
DECL_ATTR_NAME(TechnicalBeginField);
typedef GenericTarifAttribute&lt;ksTechnicalBegin, ksTechnicalBeginField, e_TBeg_n_SKIX, e_TBeg_o_SKIX, -1, -1, Date&gt; TechnicalBeginBase;
class TechnicalBegin : public TechnicalBeginBase
{
	///
	/// This class derives the technical begin of a tariff
	///
public:
	TechnicalBegin(CoverageItemContext* pParent, Record * pRec) : TechnicalBeginBase(pParent, pRec) {};
protected:
	void Calculate();
	void CalculateOld();
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>math_life/tarif/tlife_coverageitem_attributes.cpp</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">//-----------------------------------------------------------------------------
// Implementation of TechnicalBegin
IMPL_ATTR_NAME(TechnicalBegin, "TechnicalBegin");
IMPL_ATTR_NAME(TechnicalBeginField, "TECHBEGINN");

///
/// This method determines the current technical begin
///
void TechnicalBegin::Calculate()
{
	...
}

///
/// This method determines the original technical begin
///
void TechnicalBegin::CalculateOld()
{
 ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueloading"><a class="anchor" href="#trueloading"></a>7.4. Loading</h3>
<div class="paragraph">
<p>Loading describes the process of creating the context tree and setting primary keys of the contexts records.</p>
</div>
<div class="paragraph">
<p>The method called by the framework is the overwritten method <code>void Load()</code> of a context.
Lets walk through the method <code>ContractContext::Load()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ContractContext::Load ()
{
	if (m_CompTyp.Get().Empty()) {
		m_CompTyp.SetValue("X");        <i class="conum" data-value="1"></i><b>(1)</b>
	}

    m_MainClassRecord.SetKey(m_HSPKey.Get().AsString());   <i class="conum" data-value="2"></i><b>(2)</b>

	if (m_vCoverage.empty()) {
		Relation r(&amp;m_ContractRecord, "TVERSVERTRAG", "VERSV#", e_Current);  <i class="conum" data-value="3"></i><b>(3)</b>

		if (r.size() == 0) {
			// The contract '@' has no coverage
			THROW(DbInconsistency(814, m_Name));     <i class="conum" data-value="4"></i><b>(4)</b>
		}

		if (MathReg::GetVal(MR_BATCH)) {
			if (!NewBusiness() &amp;&amp; OldSpecialLogic()) {   <i class="conum" data-value="5"></i><b>(5)</b>
				DataBuffer::SetOldSpecial();
			}
			else {
				DataBuffer::ResetOldSpecial();
			}
		}

		int size = r.size();
		for (int i = 0; i &lt; size; i++){
			Record *rec = r.RecordPtr(i);             <i class="conum" data-value="6"></i><b>(6)</b>

			std::string aClassOwn = rec-&gt;GetValue("SPARTE_EIGEN");
			std::string sState = rec-&gt;GetValue("ZUSTAND");
			bool load = false;

			if (sState != "S") {
				load = true;
			}
			else {
				// these Coverages are always loaded
				if (aClassOwn == "LE" || aClassOwn == "AF" )       <i class="conum" data-value="7"></i><b>(7)</b>
				{
					load = true;
				}
			}

			if (aClassOwn == "AF") {
				SetFundsContract(true, false);
			}

			if (load) {
				CoverageContext *pCoverage = new CoverageContext(r.Value(i), this); <i class="conum" data-value="8"></i><b>(8)</b>
				m_vCoverage.push_back(pCoverage);
			}
		}

		std::vector&lt;CoverageContext*&gt;::const_iterator iter = m_vCoverage.begin(); <i class="conum" data-value="9"></i><b>(9)</b>
		std::vector&lt;CoverageContext*&gt;::const_iterator iterEnd = m_vCoverage.end();
		for(;iter != iterEnd; ++iter) {
			CoverageContext *pCurrentCoverage = *iter;

			if (pCurrentCoverage-&gt;m_ClassOwn.Get().AsString() == "AF") {

				CoverageContext *pLeadingCoverage = LeadingCoverage();
				REQUIRE(pLeadingCoverage);
				const std::string StateCurrCoverage = pCurrentCoverage-&gt;m_State.Get().AsString();
				const std::string&amp; StateLeadingClass = pLeadingCoverage-&gt;m_State.Get().AsString();

				if (StateCurrCoverage != "S" ||
					StateLeadingClass == "S" &amp;&amp; !pLeadingCoverage-&gt;ProductChange()) {
					SetFundsContract(true);
				}
			}
		}
	}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Some busines logic: setting value of <code>m_CompTyp</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Primary key of record <code>m_MainClassRecord</code> is set using value of <code>m_HSPKey</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Relation from TVERTRAG (represented by record m_ContractRecord) to TVERSVERTRAG using column VERTR#</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Error handling. In this instance if contract has no coverages.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Some business logic regarding being in batch mode or not.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Getting a record pointer out of the relation object.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Some busines logic regarding which coverages should be loaded after all.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Creating a sub-context of class <code>CoverageContext</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Some business logic regarding state of coverage records.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As one can see not only creating of sub-contexts and setting of primary keys is done in the loading method but necessary business logic is implemented here as well.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecomputing"><a class="anchor" href="#truecomputing"></a>7.5. Computing</h3>
<div class="paragraph">
<p>The method called by the framework to start the actual computing or rating process is the overwritten method <code>void Compute()</code> of a context.</p>
</div>
<div class="paragraph">
<p>The actual code in the methode <code>Compute()</code> depends entirely on the business logic.<br>
On one point the calculation of a value of an attribute representing the premium will be triggered by calling its <code>Get()</code> method.</p>
</div>
<div class="paragraph">
<p>For example in <code>ContractContext::ComputeFundsContract()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">    if (BatchJob()) {
		if (m_TotalPremBatch == 0.0) {
			restPremium = m_ContractNetPremium.Get().AsDouble(); <i class="conum" data-value="1"></i><b>(1)</b>
		}
		else {
			restPremium = m_TotalPremBatch.AsDouble();  <i class="conum" data-value="2"></i><b>(2)</b>
        }
	    m_MathState.SetMathState(PREMIUMTARGET);
    }
    else {
        restPremium = m_ContractNetPremium.Get().AsDouble(); <i class="conum" data-value="1"></i><b>(1)</b>
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Value of <code>m_ContractNetPremium</code> is triggered.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Value of <code>m_TotalPremBatch</code> is triggered. The <code>m_TotalPremBatch.AsDouble()</code> is equivalent to <code>m_TotalPremBatch.Get().AsDouble()</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueruncalculationrule"><a class="anchor" href="#trueruncalculationrule"></a>7.6. RunCalculationRule</h3>
<div class="paragraph">
<p>To trigger a CPL rating one has to call method <code>TcdSharedContext::RunCalculationRule()</code> which is an override of <code>AttributeContext::RunCalculationRule()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">	  char  RunCalculationRule(
		  const std::string&amp; designation, <i class="conum" data-value="1"></i><b>(1)</b>
		  const std::string&amp; category, <i class="conum" data-value="2"></i><b>(2)</b>
		  Type&amp; result, <i class="conum" data-value="3"></i><b>(3)</b>
		  bool old = false, <i class="conum" data-value="4"></i><b>(4)</b>
		  char desiredType = LTB_TYPE_ANY, <i class="conum" data-value="5"></i><b>(5)</b>
		  UseOfValues useOfValues = e_OldAndNew, <i class="conum" data-value="6"></i><b>(6)</b>
		  bool flv = false) override; <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The CPL designation / description of the calculation rule</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The CPL category</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The result value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Are old values used</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>LTP type</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use of values (new, old or both)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Is this a funds rating.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Example <code>CovItemPremium::Calculate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void CovItemPremium::Calculate ()
{
    ...

	Number value;
	if (GetContext()-&gt;RunCalculationRule("RIPRE", LTB_CATEGORY_PREMIUM, value) == <i class="conum" data-value="1"></i><b>(1)</b>
	                                     LTB_TYPE_MISSING) {
		THROW(DbInconsistency(818, "RIPRE"));       <i class="conum" data-value="2"></i><b>(2)</b>
	}

	if (value.AsDouble() &lt; 0.0) {
		THROW(InternalError("MathIntern", 931,
		m_pCoverageItem-&gt;m_ComponentDescription.Get().AsString()));       <i class="conum" data-value="3"></i><b>(3)</b>
	}
	if (value.AsDouble() &gt; 100000000.0) {
		THROW(InputError(235,"The error message in CovItemPremium::Calculate () must be defined!"));
	}

	...

	value = math::Round(value.AsDouble(), 2); <i class="conum" data-value="4"></i><b>(4)</b>
	SetValue(value); <i class="conum" data-value="5"></i><b>(5)</b>

    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call of calculation rule.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Exception handling in case the rule was not found.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Business logic error handling</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Rounding of value. Perhaps to fit database field.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Setting value of attribute <code>CovItemPremium</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By calling method <code>RunCalculationRule</code> the CPL code will start searching for attributes using the ids given to the attribute and will call the attributes <code>Get()</code> or <code>GetOld()</code> method which when called the first time will call the attributes <code>Compute()</code> or <code>ComputeOld()</code> method.<br>
This can trigger a while cascade of calculations and sub-calculations with several calculation rules called in the process.</p>
</div>
<div class="paragraph">
<p>To find the attributes with the id requestet by CPL the standard finding algorithm is this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Look in the current context</p>
</li>
<li>
<p>Look in the parent context</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This algorithm can be overwritten by overriding the method ` AttributeContext::FindAttribute(int id, bool recursive) `:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">    virtual Attribute* FindAttribute (int id, bool rekursiv);</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example for this is <code>FundsTariff::FindAttribute()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">Attribute * FundsTariffContext::FindAttribute(int id, bool recursive)
{
	Attribute *attr = NULL;
	attr = AttributeContext::FindAttribute(id, recursive); <i class="conum" data-value="1"></i><b>(1)</b>
	// if nothing is found search child context and then main tarif ctx
	if (attr == NULL) {
		attr = m_pFundsUnitsContext-&gt;FindAttribute(id, false); <i class="conum" data-value="2"></i><b>(2)</b>
	}
	if (attr == NULL) {
		attr = m_pCoverage-&gt;Contract()-&gt;MainTariff()-&gt;FindAttribute(id, recursive); <i class="conum" data-value="3"></i><b>(3)</b>
	}
	REQUIRE(attr != NULL);
	return attr;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the default algorithm.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If nothing is found look in specific context (here the fund units context).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If nothing is found still look in main tariff.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>CPL will then fetch the attributes needed and identified by theirs id using callback methods with lead to call <em>Attribute::Get()</em> or <em>Attribute::GetOld()</em> respectively.</p>
</div>
<div class="paragraph">
<p>This sequence diagram shows a simpliefied view of the calls:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/sequence_runcalculationrule.svg" alt="sequence runcalculationrule">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedependencies"><a class="anchor" href="#truedependencies"></a>7.7. Dependencies</h3>
<div class="paragraph">
<p>For calculation rules and ranges dependencies can be defined.</p>
</div>
<div class="paragraph">
<p>These dependencies reflect the values in certain columns in tables TLTARBESCHR and TPRODSCHGRENZW respectively.</p>
</div>
<div class="sect3">
<h4 id="truedependencies-for-calculation-rules"><a class="anchor" href="#truedependencies-for-calculation-rules"></a>7.7.1. Dependencies for calculation rules</h4>
<div class="paragraph">
<p>For table TLTARBESCHR dependencies can be defined for columns LTARZUSTAND, TARIFBEREICH, RISIKOGRUPPE and KZHAUPTVP.</p>
</div>
<div class="paragraph">
<p>If a dependency with a default value must be defined, create a <code>TCD::Dependency</code>.
Here is an example for attribute risk group with CPL id e_risikogruppe_vp1_n_SKIX.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">static constexpr const char* RISK_GROUP_DEFAULT_VALUE = "XXXXX";
static const auto RISK_GROUP_DEPENDENCY = TCD::Dependency(e_riskGroup_vp1_n_SKIX, RISK_GROUP_DEFAULT_VALUE);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dependecies without default value are simply identified by their CPL id or the id the attribute holds.</p>
</div>
<div class="paragraph">
<p>These dependencies are put in a map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">TCD::DependenciesMap BaseContext::s_TProdSchGrenzWDependencies =
{
	{ "KMNX",{ { RISK_GROUP_DEPENDENCY } } }, <i class="conum" data-value="1"></i><b>(1)</b>
	{ "RIPBE",{ { AUS_TAR_ZUSTAND_ID } } }    <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dependency with default value.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dependency without default value.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truedependencies-for-ranges"><a class="anchor" href="#truedependencies-for-ranges"></a>7.7.2. Dependencies for ranges</h4>
<div class="paragraph">
<p>Dependencies for ranges work similar to dependencies for calculation rules.</p>
</div>
<div class="paragraph">
<p>For table TPRODSCHGRENZW dependencies defined can be for columns TARIFBEREICH, RISIKOGRUPPE and KZHAUPTVP.</p>
</div>
<div class="paragraph">
<p>In this example all ranges have two dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">static constexpr const char* RISK_GROUP_DEFAULT_VALUE = "XXXXX";
static const auto RISK_GROUP_DEPENDENCY = TCD::Dependency(e_RiskGroup_IP1_n_SKIX, RISK_GROUP_DEFAULT_VALUE);

static const auto MAIN_INSURED_PERSON_DEPENDENCY = TCD::Dependency{ FLAG_MAININSURED };

TCD::DependenciesMap BaseContext::s_TProdSchGrenzWDependencies =
{
	{ "EINAL",{ RISK_GROUP_DEPENDENCY, MAIN_INSURED_PERSON_DEPENDENCY } },
	{ "PRALT",{ RISK_GROUP_DEPENDENCY, MAIN_INSURED_PERSON_DEPENDENCY } }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truedependencies-for-cpl-tables"><a class="anchor" href="#truedependencies-for-cpl-tables"></a>7.7.3. Dependencies for CPL tables</h4>
<div class="paragraph">
<p>You have to overwrite some methods of class `TcdSharedContext' to deal with CPL tables. These are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">  virtual bool IsTCDTable ( const std::string&amp; sTabName );
  virtual bool IsTCDTable ( int id );
  virtual void InitTCDTableMap () = 0;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example from math_life:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">///
/// This method initializes the table mapping for TCD
/// Adaptions based on the respective TCD Module are required
///
void ContractContext::InitTCDTableMap()
{
	TCD::setTableDependencies(MortalityTab_T2IX, "KMNX"); <i class="conum" data-value="1"></i><b>(1)</b>
	TCD::setTableDependencies(CostTab_T2IX, "KSTMA");

	//TCD::setTableDependenciesUnisex(AltersVerschiebung_T2IX, "ALT", "VS", { { "RisikoGruppe", "XXXXX" } });
}

///
/// This method checks if the searched ID is a TCD table
///
bool ContractContext::IsTCDTable(int id)
{
	return TCD::hasTableDependencies(id);
}

///
/// This method checks if the searched Name is a TCD table
///
bool ContractContext::IsTCDTable(const std::string&amp; sTableName)
{
	return TCD::hasTableDependencies(sTableName);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the <code>TCD::TableDependency</code> objects are created. This is needed during a CPL calculation to connect CPL external interfaces to the actual tables in CPL.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truegetrange"><a class="anchor" href="#truegetrange"></a>7.8. GetRange</h3>
<div class="paragraph">
<p><code>TcdSharedContext::GetRange()</code> is responsible for fetching minimum and maximum values for certain rules.<br>
It will fetch this data from the table TPRODSCHGRENZW considering dependency maps in the process.</p>
</div>
<div class="paragraph">
<p>This sequence diagram shows a simpliefied view of the calls:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./04_mathematics_object_model/media/sequence_getrange.svg" alt="sequence getrange">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truesaving"><a class="anchor" href="#truesaving"></a>7.9. Saving</h3>
<div class="paragraph">
<p>After a sucessful computing the relevant attributes will hold the new values. To write them back into the actual data buffers the virtual method <code>Attribute::Save()</code> is called. This method is overwritten for example in class <code>InputAttribute</code> with an empty method since <code>InputAttribute</code> objects are read only.</p>
</div>
<div class="paragraph">
<p>You don&#8217;t have to call the method <code>Attribute::Save()</code> for all your attributes yourself. The virtual method <code>AttributeContext::Save()</code> will take care of that. What <code>AttributeContext::Save()</code> does not do is calling the <code>Save()</code> method of its child contexts. That is the reason why in most contexts with child contexts the <code>Save()</code> method must be overwritten.</p>
</div>
<div class="paragraph">
<p>This is for example method <code>ContractContext::Save()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void ContractContext::Save ()
{

	AttributeContext::Save(); <i class="conum" data-value="1"></i><b>(1)</b>

	std::vector&lt;CoverageContext *&gt;::iterator iCoverage;
	for (iCoverage = m_vCoverage.begin(); iCoverage != m_vCoverage.end(); ++iCoverage) {
		(*iCoverage)-&gt;Save(); <i class="conum" data-value="2"></i><b>(2)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Saving of all attributes in current context</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call virtual method <code>AttributeContext::Save()</code> for all child contexts.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The method <code>Save()</code> of your root context (usually contract) is called by the framwork.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truelogging"><a class="anchor" href="#truelogging"></a>8. Logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Logging in the MOM framework uses the Log for C++ Project (Log4cpp),
which is modelled after the Log4J Java Library. See</p>
</div>
<div class="paragraph">
<p><a href="http://log4cpp.sourceforge.net/" class="bare">http://log4cpp.sourceforge.net/</a></p>
</div>
<div class="sect2">
<h3 id="truelogging-configuration"><a class="anchor" href="#truelogging-configuration"></a>8.1. Logging configuration</h3>
<div class="paragraph">
<p>To enable logging in the mom the configuration setting <code>MATH_TRACE_CONFIG</code> in section <code>[PATH]</code> mus be set.</p>
</div>
<div class="paragraph">
<p>This for example sets the loggig configuration for MOM to the file <code>math_trace.cfg</code> in the configuration file (math.ini):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">...
[PATH]
MATH_TRACE_CONFIG=math_trace.cfg
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of a logging configuration logging to STDOUT and the file math_trace_file.txt. For the exact sytnax and configuration options please refer to the documentation of Log4cpp.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">log4cplus.rootLogger=ALL, LOG, STDOUT <i class="conum" data-value="1"></i><b>(1)</b>

log4cplus.appender.STDOUT=log4cplus::ConsoleAppender <i class="conum" data-value="2"></i><b>(2)</b>
log4cplus.appender.STDOUT.ImmediateFlush=true
log4cplus.appender.STDOUT.layout=log4cplus::PatternLayout
log4cplus.appender.STDOUT.layout.ConversionPattern=%x%-5.5p [%c]%m%n <i class="conum" data-value="4"></i><b>(4)</b>

log4cplus.appender.LOG=log4cplus::FileAppender <i class="conum" data-value="3"></i><b>(3)</b>
log4cplus.appender.LOG.File=math_trace_file.txt
log4cplus.appender.LOG.Append=false
log4cplus.appender.LOG.layout=log4cplus::PatternLayout
log4cplus.appender.LOG.layout.ConversionPattern=%x%D{%Y.%m.%dT%H:%M:%S.%q} [%-6.6t] %-5.5p %c %m%n <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This line defines the priority of logging. In this case <code>ALL</code>. And it defines the actual loggers (appenders) also. Here they are <code>LOG</code> and <code>STDOUT</code>. To leave out the logger <code>STDOUT</code> and use only logger <code>LOG</code> this line would look like this: <code>log4cplus.rootLogger=ALL, LOG</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuation of console logger STDOUT</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configuation of file logger LOG</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>ConversionPattern. More on this below.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The priority of logging can be set to one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ALL</p>
</li>
<li>
<p>DEBUG</p>
</li>
<li>
<p>INFO</p>
</li>
<li>
<p>NOTICE</p>
</li>
<li>
<p>WARN</p>
</li>
<li>
<p>ERROR</p>
</li>
<li>
<p>CRIT</p>
</li>
<li>
<p>ALERT</p>
</li>
<li>
<p>FATAL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>They are listed in ascending order of "logginess" or importance level of each message. FATAL is highest level of importance.<br>
NOTSET is the lowest and if a category object is left with an ALL priority, it will accept and log any message.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueconversionpattern"><a class="anchor" href="#trueconversionpattern"></a>8.2. ConversionPattern</h3>
<div class="paragraph">
<p>The format of the output is determined by the configuration setting <code>ConversionPattern</code>. Find the documentation of this under this link:</p>
</div>
<div class="paragraph">
<p><a href="https://log4cplus.sourceforge.io/docs/html/classlog4cplus_1_1PatternLayout.html" class="bare">https://log4cplus.sourceforge.io/docs/html/classlog4cplus_1_1PatternLayout.html</a></p>
</div>
<div class="paragraph">
<p>One important setting might be the use of <code>%x</code>. It enables indentation for human readable format. This is useful if the audience of the logs are human beings.</p>
</div>
<div class="paragraph">
<p>Should the log on the other hand used by log management tools like Kibana a JSON conversion pattern might be used. An example for this kind of loggig could be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>...
log4cplus.appender.STDOUT.layout.ConversionPattern={ "log_type" : "MATH_LIFE", "hostname":"%H", "openshift_build_commit": "%E{OPENSHIFT_BUILD_COMMIT}", "openshift_build_name": "%E{OPENSHIFT_BUILD_NAME}", "message":"%m", "timestamp" : "%D{%Y.%m.%dT%H:%M:%S.%q}" }%n
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>"%E{OPENSHIFT_BUILD_COMMIT}"</code> and <code>"%E{OPENSHIFT_BUILD_NAME}"</code> refer to the environment variables OPENSHIFT_BUILD_COMMIT and OPENSHIFT_BUILD_NAME respectively.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueusage-in-code"><a class="anchor" href="#trueusage-in-code"></a>8.3. Usage in code</h3>
<div class="paragraph">
<p>To include logging in the actual code use class <code>Trace</code>. This class has some static methods to for logging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class Trace
{
public:
    static void Message   ( AttributeContext* ktx, log4cplus::LogLevel severity,
                            const std::string&amp; sMessage ) DLL_LOCAL;
    static void TraceLine ( AttributeContext* ktx, const std::string&amp; sMessage ) DLL_LOCAL;
    static void Debug     ( AttributeContext* ktx, const std::string&amp; sMessage ) DLL_LOCAL;
    static void Info      ( AttributeContext* ktx, const std::string&amp; sMessage ) DLL_LOCAL;
    static void Warning   ( AttributeContext* ktx, const std::string&amp; sMessage ) DLL_LOCAL;
    static void Error     ( AttributeContext* ktx, const std::string&amp; sMessage ) DLL_LOCAL;
    static void Fatal     ( AttributeContext* ktx, const std::string&amp; sMessage ) DLL_LOCAL;
    static void Exception ( AttributeContext* ktx, std::string const&amp;  name,
                            std::string const&amp;  result = "") DLL_LOCAL;
    ...
    class Start {
       ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usage in code could look like this example from  <code>CoverageItemContext::ComputeBasedOnGivenAnnuity</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">...
Trace::Info(this, "ComputeBasedOnGivenAnnuity " +  m_CovItemTotalSum.Get().AsString());
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the log this would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-plaintext" data-lang="plaintext">2020.12.22T10:50:29.825 [67000 ] INFO  root 1f905c9d-443b-11eb-ab58-fc7774f507ac:ComputeBasedOnGivenAnnuity 10000 Location: AttributeContext::AttributeContext:94: FERTIG</code></pre>
</div>
</div>
<div class="paragraph">
<p>In trace_profiler.h some macros regarding logging are defined. <code>TRACE_START</code> for example will create two lines in the log. One line immediately and one line when the underlying instance of class <code>Trace::Start</code> will go out of context.</p>
</div>
<div class="paragraph">
<p>In the log this would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-plaintext" data-lang="plaintext">2020.12.22T10:50:16.542 [31396 ] INFO  NO_CONTEXT compute, handle: 791218144 pclass:  pkey:  attribute:  Location: compute:129: START
....
2020.12.22T10:50:20.072 [31396 ] INFO  NO_CONTEXT compute, handle: 791218144 pclass:  pkey:  attribute:  Location: compute:129: END  ExecTime: 3530 ms.
----</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconfiguration"><a class="anchor" href="#trueconfiguration"></a>9. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configuration settings within the MOM are being dealt with by class <code>ParameterManager</code> no matter where these settings come from.</p>
</div>
<div class="paragraph">
<p>Settings can be global or specific to a session.</p>
</div>
<div class="paragraph">
<p>The source of global settings can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Environment variables</p>
</li>
<li>
<p>Configuration file</p>
</li>
<li>
<p>Configuration service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is also the order the settings are fetched from. Is a value found in the environment vairables, it will not be searched further and so on.
This leads to the behaiour that settings in the configuration file for example override the settings in the config service.</p>
</div>
<div class="paragraph">
<p>To locate a specific configuration setting two values are needed: branch and name.
Is no branch given the default branch <code>SWITCHES</code> is assumed.</p>
</div>
<div class="paragraph">
<p>Environment variables do not necessarily need a branch. Is a branch given, then an environment variable in the form of <em>{branch} _ {name}</em> is fetched. For example: MYSETTING in SWITCHES would lead to look in environment variable <code>MYSETTING_SWITCHES</code>.</p>
</div>
<div class="paragraph">
<p>A configuration file like math.ini could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[SWITCHES] <i class="conum" data-value="1"></i><b>(1)</b>
MATH_TRACE=ON <i class="conum" data-value="2"></i><b>(2)</b>
MATH_SESSION_CACHING=OFF

[RSS] <i class="conum" data-value="1"></i><b>(1)</b>
LOGGER_CONFIG=rss_logger.cfg
COMPUTE_IN_PROCESS=OFF
DD_DRIVER_JARS=db2jcc4-4.19.49.jar;db2jcc_license_cisuz.jar;db2jcc_license_cu.jar;jdbcjni.jar
DD_DRIVER_CLASS=com.ibm.db2.jcc.DB2Driver
DD_DRIVER_PATH=C:\dev\rss\
URL_KEYCLOAK=https://keycloak.allianz.at:8456/auth/x
URL_CONFIGSERVICE=https://config.allianz.at:8811/x/rss-dev.json

[PATH] <i class="conum" data-value="1"></i><b>(1)</b>
MATH_TRACE_CONFIG=math_trace.cfg <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Branch.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setting in branch [SWITCHES]</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Setting in branch [PATH]</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Session wide settings are being provided by the section <code>settings</code> in the input JSON from rss.</p>
</div>
<div class="paragraph">
<p>Example of fetching a global setting from branch <code>SWITCHES</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">std::string sCommaString = ParameterManager::Instance().GetStringVal("MATH_COMMA", "SWITCHES");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example of fetching a session specific setting from branch <code>SWITCHES</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">const std::string&amp; lastMessage = ParameterManager::Instance().GetStringVal("LAST_MESSAGE", "SWITCHES", GlobalOptions::Instance().CurrentSession());</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="trueexercise-2"><a class="anchor" href="#trueexercise-2"></a>9.1. Exercise</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Add to your custom MOM some more contexts: a coverage context, a coverage item context and a insured persson context.<br>
Create at least three records per context.<br>
Create at least three attributes per context.<br>
Implement the loading of the contexts.<br>
Implement the compute method.<br>
Add some logging.<br>
Use some configuration settings defined by you.<br>
Add at least one call of RunCalculationRule().
Add at least one call of GetRange().
Look the the code of project math_life for input.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecontext-descriptors"><a class="anchor" href="#truecontext-descriptors"></a>10. Context Descriptors</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">template
&lt; class TComputer
, class TLoader
, class TFinder &gt;
class ContextDescriptor : public ContextDescriptorBase
{
    …
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The purpose of ContextDescriptors is to allow code reuse for the main operations that any context type has to perform:
-	load itself,
-	find attributes by ID, by name or by persistent column name,
-	compute itself
The three operations have to be defined in standalone classes as this will allow composing them in any combination into new context types. For example, one might have two different context types that compute and load themselves differently but use the same algorthms for finding attributes. In this case the finder class can be shared by the two ContextDescriptors.
Defining Contexts and linking them to a ContextDescriptor is a compile-time operation. The ContextClass using a specific combination of loader/finder/computer has to override the Descriptor() method and return the correct descriptor instance from it. This will enable the framework base to call the implemented Descriptor Classes when needed.
For example, class CoverageKtx defines its descriptor as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">typedef ContextDescriptor&lt;CoverageCtxComputer, ProtoCtxDefaultLoader&lt;CoverageCtx&gt;, AttributeCtxAttributeFinder&gt; CoverageDescriptor;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and declares an instance variable of this type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">CoverageDescriptor m_Descriptor;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Descriptor method will return this instance to the caller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">virtual const ContextDescriptorBase*  Descriptor () const { return &amp;m_Descriptor; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following subsections describe the structure of the three descriptor classes and the methods that they must implement.</p>
</div>
<div class="sect2">
<h3 id="trueloader"><a class="anchor" href="#trueloader"></a>10.1. Loader</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class AttributeCtxLoaderBase
{
public:
    virtual void operator()( AttributeContext* pCtx, AttributeContext* pOwner ) const = 0;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The defined function call operator which takes two parameters, implements the load functionality for your context. The first parameter (pCtx) is the context being loaded. The second parameter (pOwner) is the parent of the current context. The parent context might be needed during the load operation and this is why the framework passes it through.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecomputer"><a class="anchor" href="#truecomputer"></a>10.2. Computer</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">typedef IteratorAlg&lt;void, AttributeContext&gt; AttributeCtxComputerBase;</code></pre>
</div>
</div>
<div class="paragraph">
<p>class IteratorAlg also defines as mandatory a function call operator taking just one parameter of type AttributeContext. Implement compute functionality there.</p>
</div>
</div>
<div class="sect2">
<h3 id="truefinder"><a class="anchor" href="#truefinder"></a>10.3. Finder</h3>
<div class="paragraph">
<p>Finder can implement up to tree overloaded methods Find() dependent on which of the methods FindAttribute() or FindAttributeByName() in AtributeContext are being used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class AttributeCtxAttributeFinder
{
public:
  …
    virtual Attribute* Find (AttributeContext* pCtx, int id, bool recursive
    virtual Attribute* Find (AttributeContext* pCtx, const std::string&amp;
                             name, bool recursive);
    virtual Attribute* FindByName (AttributeContext *pCtx, const
  …
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The three methods of the loader class are used to find attribute by ID, name or persistent column name and only by string name. See AttributeCtxAttributeFinder implementation in attrktx.h/.cpp for a concrete example.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecontext-iterator-algorithms"><a class="anchor" href="#truecontext-iterator-algorithms"></a>11. CONTEXT ITERATOR ALGORITHMS</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp"></code></pre>
</div>
</div>
<div class="paragraph">
<p>Often it is necessary to iterate through all child contexts to perform the same operation. In this case the class template ChildContextIterator is helpful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">Definition context iterator:
template &lt;class ChildContextType&gt;
class ChildContextIterator
{
public:
    ChildContextIterator(AttributeContext* pContextToIterate, const
	IteratorAlg&lt;double, ChildContextType&gt;&amp; rAlg )
    …

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Definition iterator algorithm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">template &lt;class retType, class iterType&gt;
class IteratorAlg
{
    …
    virtual retType operator()( iterType* pParent ) const = 0;
    …
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To define an algorithm that is used to iterate through the list of child contexts one has to inherit from IteratorAlg and specialize it as needed.
Requirements for the iterator algorithm class are:
-	retType has to be a type implementing the operator+ or some primitive numeric type that allows addition. The result of iterating over the child contexts will always be the sum of the results returned by the function call operator of the iterator algorithm on each of the child contexts of the given type.
-	iterType has to be specialized to a Context class inherited class (or AttributeContext to iterator over all the child contexts)
Runtime Type Information (RTTI) has to be enabled at compile time as ChildContextIterator class makes use of this information to determine at runtime the list of contexts that the Algorithm will be applied to.
For example, for iterating all child contexts of type CoverageContext of a ContractContext one can use following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">ChildContextIterator&lt;CoverageCtx&gt; ( this, CalcPremiumIteratorAlg() ).Iterate();</code></pre>
</div>
</div>
<div class="paragraph">
<p>CalcPremuimIteratorAlg is an implementation of the IteratorAlg class specialized with double for retType and CoverageKtx for iterType:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">class CalcPremuimIteratorAlg : public IteratorAlg&lt;double, CoverageCtx&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class has to implement the pure virtual function call operator defined in the base class: ret_type operator()( iter_type* pParent ) const
The result of this iteration will be the sum of the premiums calculated for each of the CoverageContext instances from this ContractContext.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueoverview-framework-classes"><a class="anchor" href="#trueoverview-framework-classes"></a>12. Overview framework classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The table below lists the most important classes of the MOM framework.</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">class name</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Attribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">base class for all attributes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>InputAttribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">class for reading value with no further logic; value can change during</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefiningAttribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">class for read only attributes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AttributeContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">base class for attribute contexts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AttributeRange</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">holds the minimum and maximum value allowed. Used by <code>GetRange()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AttributeKind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">meta-class for class <code>Attribute</code> that holds all relevant information</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Record</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">implementation indepedend class for access to data buffers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DataBuffer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">base class for implementation specific data buffers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JsonDataBuffer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">data buffer class implementation for dealing with rss JSON</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CacheChainDataBuffer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">data buffer for database access and caching fetched data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValueGetter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">functional object to parametrize getting the various kinds of value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValueSetter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">functional object to parametrize setting the various kinds of value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exception</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">base class for excetion classes (e.g. <code>InternalError</code>, <code>AssertError</code>, <code>DataBufferMissing</code>, &#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">base class for types of attributes such as <code>Number</code>, <code>Text</code>, <code>Date</code>, <code>Percent</code>, &#8230;&#8203;</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-10-11 18:00:31 +0200
</div>
</div>
</body>
</html>